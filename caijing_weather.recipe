#!/usr/bin/env python
# -*- coding: utf-8 -*-
import os, json
from calibre.web.feeds.news import BasicNewsRecipe

STATE_DIR  = 'state'                       # 相对路径
os.makedirs(STATE_DIR, exist_ok=True)
STATE_FILE = os.path.join(STATE_DIR, 'seen.json')

class CaijingWeather(BasicNewsRecipe):
    title  = u'财经·天气（日增量）'
    oldest_article = 6
    max_articles_per_feed  = 100
    auto_cleanup  = True
    timeout = 60

    feeds = [
        ('半月谈', 'http://feedmaker.kindle4rss.com/feeds/banyuetan-weixin.weixin.xml'),
        ('36氪 • 24h 热榜', 'https://rss.mifaw.com/articles/5c8bb11a3c41f61efd36683e/5c91d2e23882afa09dff4901'),
        ('量子位 • 专栏', 'https://rss.lilydjwg.me/zhihuzhuanlan/qbitai'),
    ]

    def initialize(self):
        BasicNewsRecipe.initialize(self)
        try:
            with open(STATE_FILE, 'r', encoding='utf-8') as f:
                self.seen = set(json.load(f))
        except Exception:
            self.seen = set()
        self.new_cnt = 0

    def skip_article(self, a):
        gid = a.get('id') or a.get('guid') or a.get('link')
        if gid and gid in self.seen:
            return True
        if gid:
            self.seen.add(gid)
        self.new_cnt += 1
        return False

    def get_browser(self):
        br = BasicNewsRecipe.get_browser(self)
        br.set_proxies({})
        br.addheaders += [
            ('User-Agent','Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/124 Safari/537.36'),
            ('Accept-Encoding','identity'),
        ]
        return br

    def postprocess_book(self, oeb):
        if self.new_cnt == 0:
            self.abort('No new articles')
        with open(STATE_FILE, 'w', encoding='utf-8') as f:
            json.dump(list(self.seen), f)
