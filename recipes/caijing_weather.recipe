class CaijingWeather(BasicNewsRecipe):
    title  = '财经·天气（日增量）'
    oldest_article        = 6
    max_articles_per_feed = 100
    auto_cleanup          = True
    timeout               = 60
    no_stylesheets        = True

    new_cnt = 0           # <—— 关键：放在这里，实例无论如何都有这个属性

    feeds = [
        # ...
    ]

    # ---------- 初始化 ----------
    def initialize(self):
        super().initialize()
        try:
            with open(STATE_FILE, 'r', encoding='utf-8') as f:
                self.seen = set(json.load(f))
        except Exception:
            self.seen = set()
        self.new_cnt = 0   # 仍然重置，保持既有逻辑
        self.log(f'Init OK, seen {len(self.seen)} items')

    # ---------- 去重 ----------
    def skip_article(self, a):
        gid = a.get('id') or a.get('guid') or a.get('link')
        if gid and gid in self.seen:
            return True
        if gid:
            self.seen.add(gid)
        self.new_cnt += 1
        return False

    # ---------- 生成后处理 ----------
    def postprocess_book(self, oeb, opts, log):
        # 保险起见再获取一次
        cnt = getattr(self, 'new_cnt', 0)
        if cnt == 0:
            if AbortRecipe:
                raise AbortRecipe('No new articles')
            else:
                self.abort_recipe_processing('No new articles')
        with open(STATE_FILE, 'w', encoding='utf-8') as f:
            json.dump(list(self.seen), f)
